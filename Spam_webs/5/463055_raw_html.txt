<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Motherboard Chipsets and the Memory Map - Gustavo Duarte
  </title>
  <meta content="Gustavo Duarte" name="author"/>
  <meta content="Im going to write a few posts about computer internals with the goal of
explaining how modern kernels work. I hope to make them useful to " name="description"/>
  <link href="http://duartes.org/gustavo/blog/post/motherboard-chipsets-memory-map" rel="canonical"/>
  <link href="/gustavo/blog/favicon.ico" rel="shortcut icon"/>
  <link href="http://feeds.feedburner.com/GustavoDuarte" rel="alternate" title="Gustavo Duarte" type="application/atom+xml"/>
  <link href="//fonts.googleapis.com/css?family=Open+Sans:400,400italic,700|PT+Serif:400,700" rel="stylesheet" type="text/css"/>
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"/>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/gustavo/blog/stylesheets/signal.css" rel="stylesheet"/>
  <!--&lt;link href="/gustavo/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"&gt;-->
  <script type="text/javascript">
   var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3204790-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
 </head>
 <body>
  <div class="masthead">
   <div class="container masthead" role="banner">
    <h1>
     <a href="/gustavo/blog/">
      Gustavo Duarte
     </a>
    </h1>
    <h2>
     brain food for hackers
    </h2>
   </div>
  </div>
  <nav class="navbar navbar-default" role="navigation">
   <div class="container" id="blogNav">
    <div class="navbar-header">
     <button class="navbar-toggle collapsed" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
      <span class="sr-only">
       Toggle navigation
      </span>
      <span class="icon-bar">
      </span>
      <span class="icon-bar">
      </span>
      <span class="icon-bar">
      </span>
     </button>
     <a class="navbar-brand" href="/gustavo/blog">
      Blog
     </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
     <ul class="nav navbar-nav">
      <li>
       <a href="/gustavo/blog/archives/">
        Archives
       </a>
      </li>
      <li>
       <a href="/gustavo/blog/about/">
        About
       </a>
      </li>
      <li>
       <a href="http://feeds.feedburner.com/GustavoDuarte" rel="subscribe-rss" title="subscribe via RSS">
        Subscribe
       </a>
      </li>
      <li>
       <a href="//twitter.com/food4hackers" title="follow me">
        <i class="fa fa-twitter">
        </i>
       </a>
      </li>
      <li>
       <a href="http://feeds.feedburner.com/GustavoDuarte" rel="subscribe-rss" title="subscribe via RSS">
        <i class="fa fa-rss">
        </i>
       </a>
      </li>
     </ul>
    </div>
    <!-- /.navbar-collapse -->
   </div>
   <!-- /.container -->
  </nav>
  <div class="container" id="main">
   <div id="content">
    <div class="row no-gutters">
     <div class="col-lg-10">
      <article class="hentry" role="article">
       <header>
        <h1 class="entry-title">
         Motherboard Chipsets and the Memory Map
        </h1>
        <p class="meta">
         <time data-updated="true" datetime="2008-06-04T13:00:06-06:00" pubdate="">
          Jun 4
          <span>
           th
          </span>
          , 2008
         </time>
        </p>
       </header>
       <div class="entry-content">
        <p>
         Im going to write a few posts about computer internals with the goal of
explaining how modern kernels work. I hope to make them useful to
enthusiasts and programmers who are interested in this stuff but dont
have experience with it. The focus is on Linux, Windows, and Intel
processors. Internals are a hobby for me, I have written a fair bit of
kernel-mode code but havent done so in a while. This first post
describes the layout of modern Intel-based motherboards, how the CPU
accesses memory and the system memory map.
        </p>
        <p>
         To start off lets take a look at how an Intel computer is wired up
nowadays. The diagram below shows the main components in a motherboard
and dubious color taste:
        </p>
        <p>
         <img alt="Diagram for modern
motherboard" src="http://static.duartes.org/img/blogPosts/motherboardDiagram.png"/>
         \
 Diagram for modern motherboard. The northbridge and southbridge make up
the chipset.
        </p>
        <p>
         As you look at this, the crucial thing to keep in mind is that the CPU
doesnt really know anything about what its connected to. It talks to
the outside world through its
         <a href="http://en.wikipedia.org/wiki/Image:Intel_80486DX2_bottom.jpg">
          pins
         </a>
         but
it doesnt care what that outside world is. It might be a motherboard in
a computer but it could be a toaster, network router, brain implant, or
CPU test bench. There are three main ways by which the CPU and the
outside communicate: memory address space, I/O address space, and
interrupts. We only worry about motherboards and memory for now.
        </p>
        <p>
         In a motherboard the CPUs gateway to the world is the front-side bus
connecting it to the northbridge. Whenever the CPU needs to read or
write memory it does so via this bus. It uses some pins to transmit the
physical memory address it wants to write or read, while other pins send
the value to be written or receive the value being read. An Intel Core 2
QX6600 has 33 pins to transmit the physical memory address (so there are
2
         <sup>
          33
         </sup>
         ^ choices of memory locations) and 64 pins to send or receive data
(so data is transmitted in a 64-bit data path, or 8-byte chunks). This
allows the CPU to physically address 64 gigabytes of memory (2
         <sup>
          33
         </sup>
         ^
locations * 8 bytes) although most chipsets only handle up to 8 gigs of
RAM.
        </p>
        <p>
         Now comes the rub. Were used to thinking of memory only in terms of
RAM, the stuff programs read from and write to all the time. And indeed
most of the memory requests from the processor are routed to RAM modules
by the northbridge. But not all of them. Physical memory addresses are
also used for communication with assorted devices on the motherboard
(this communication is called
         <a href="http://en.wikipedia.org/wiki/Memory-mapped_IO">
          memory-mapped
I/O
         </a>
         ). These devices
include video cards, most PCI cards (say, a scanner or SCSI card), and
also the
         <a href="http://en.wikipedia.org/wiki/Flash_memory">
          flash memory
         </a>
         that
stores the BIOS.
        </p>
        <p>
         When the northbridge receives a physical memory request it decides where
to route it: should it go to RAM? Video card maybe? This routing is
decided via the memory address map. For each region of physical memory
addresses, the memory map knows the device that owns that region. The
bulk of the addresses are mapped to RAM, but when they arent the memory
map tells the chipset which device should service requests for those
addresses. This mapping of memory addresses away from RAM modules causes
the classic hole in PC memory between 640KB and 1MB. A bigger hole
arises when memory addresses are reserved for video cards and PCI
devices. This is why 32-bit OSes have
         <a href="http://support.microsoft.com/kb/929605">
          problems using 4 gigs of RAM
         </a>
         . In Linux the file
         <strong>
          /proc/iomem
         </strong>
         neatly lists these address range mappings. The diagram
below shows a typical memory map for the first 4 gigs of physical memory
addresses in an Intel PC:
        </p>
        <p>
         <img alt="Memory layout at boot
time" src="http://static.duartes.org/img/blogPosts/memoryLayout.png"/>
         \
 Memory layout for the first 4 gigabytes in an Intel system.
        </p>
        <p>
         Actual addresses and ranges depend on the specific motherboard and
devices present in the computer, but most Core 2 systems are pretty
close to the above. All of the brown regions are mapped away from RAM.
Remember that these are
         <em>
          physical
         </em>
         addresses that are used on the
motherboard buses.
         <em>
          Inside
         </em>
         the CPU (for example, in the programs we run
and write), the memory addresses are
         <strong>
          logical
         </strong>
         and they must be
translated by the CPU into a physical address before memory is accessed
on the bus.
        </p>
        <p>
         The rules for translation of logical addresses into physical addresses
are complex and they depend on the
         <em>
          mode
         </em>
         in which the CPU is running
(real mode, 32-bit protected mode, and 64-bit protected mode).
Regardless of the translation mechanism, the CPU mode determines how
much physical memory can be accessed. For example, if the CPU is running
in 32-bit mode, then it is only capable of physically addressing 4 GB
(well, there is an exception called
         <a href="http://en.wikipedia.org/wiki/Physical_address_extension">
          physical address extension
         </a>
         , but
ignore it for now). Since the top 1 GB or so of physical addresses are
mapped to motherboard devices the CPU can effectively use only \~3 GB of
RAM (sometimes less  I have a Vista machine where only 2.4 GB are
usable). If the CPU is in
         <a href="http://en.wikipedia.org/wiki/Real_mode">
          real mode
         </a>
         , then it can only address
1
         <em>
          mega
         </em>
         byte of physical RAM (this is the only mode early Intel
processors were capable of). On the other hand, a CPU running in 64-bit
mode can physically access 64GB (few chipsets support that much RAM
though). In 64-bit mode it is possible to use physical addresses above
the total RAM in the system to access the RAM regions that correspond to
physical addresses stolen by motherboard devices. This is called
         <strong>
          reclaiming
         </strong>
         memory and its done with help from the chipset.
        </p>
        <p>
         Thats all the memory we need for the next post, which describes the
boot process from power up until the boot loader is about to jump into
the kernel. If youd like to learn more about this stuff, I highly
recommend the Intel manuals. Im big into primary sources overall, but
the Intel manuals in particular are well written and accurate. Here are
some:
        </p>
        <ul>
         <li>
          <a href="http://download.intel.com/design/chipsets/datashts/31760701.pdf">
           Datasheet for Intel G35 Chipset
          </a>
          documents a representative chipset for Core 2 processors. This is
the main source for this post.
         </li>
         <li>
          <a href="http://download.intel.com/design/processor/datashts/31559205.pdf">
           Datasheet for Intel Core 2 Quad-Core Q6000 Sequence
          </a>
          is a processor datasheet. It documents each pin in the processor
(there arent that many actually, and after you group them theres
really not a lot to it). Fascinating stuff, though some bits are
arcane.
         </li>
         <li>
          The
          <a href="http://www.intel.com/products/processor/manuals/index.htm">
           Intel Software Developers Manuals
          </a>
          are outstanding. Far from arcane, they explain beautifully all sorts
of things about the architecture. Volumes 1 and 3A have the good
stuff (dont be put off by the name, the volumes are small and you
can read selectively).
         </li>
         <li>
          <a href="http://www.pixelbeat.org/">
           Pdraig Brady
          </a>
          suggested that I link to
Ulrich Dreppers excellent
          <a href="http://people.redhat.com/drepper/cpumemory.pdf">
           paper on memory
          </a>
          . Its great
stuff. I was waiting to link to it in a post about memory, but the
more the merrier.
         </li>
        </ul>
        <p>
         <a href="/gustavo/blog/comments/motherboard-chipsets.html">
          112 Comments
         </a>
        </p>
       </div>
       <footer>
        <div class="inner clearfix">
         <div class="socialNav">
          <div class="socialNav">
           <ul class="socialNav">
            <li style="float:left">
             <a href="//twitter.com/food4hackers" title="follow me">
              <img src="/gustavo/blog/images/twitter.png"/>
             </a>
            </li>
            <li style="float:right">
             <a href="mailto:food4hackers@duartes.org" title="email me">
              <img src="/gustavo/blog/images/email.png"/>
             </a>
            </li>
            <li>
             <a href="http://feeds.feedburner.com/GustavoDuarte" rel="subscribe-rss" title="subscribe via RSS">
              <img src="/gustavo/blog/images/rss.png"/>
             </a>
            </li>
           </ul>
          </div>
         </div>
        </div>
        <p class="meta-footer">
         <i class="fa fa-user">
         </i>
         <span>
          Posted by
          <span>
           Gustavo Duarte
          </span>
         </span>
         <i class="fa fa-calendar">
         </i>
         <time data-updated="true" datetime="2008-06-04T13:00:06-06:00" pubdate="">
          Jun 4
          <span>
           th
          </span>
          , 2008
         </time>
         <i class="fa fa-tags">
         </i>
         <span class="categories">
          <a class="category" href="/gustavo/blog/category/internals/">
           Internals
          </a>
          ,
          <a class="category" href="/gustavo/blog/category/software-illustrated/">
           Software Illustrated
          </a>
         </span>
        </p>
        <div class="sharing">
        </div>
        <p>
         <a href="/gustavo/blog/post/of-aviation-crashes-and-software-bugs/" title="Previous Post: Of Aviation Crashes and Software Bugs">
           Of Aviation Crashes and Software Bugs
         </a>
         <a href="/gustavo/blog/post/how-computers-boot-up/" style="float:right" title="Next Post: How Computers Boot Up">
          How Computers Boot Up 
         </a>
        </p>
       </footer>
      </article>
     </div>
     <aside class="sidebar col-lg-2">
      <section class="panel panel-default titleFont">
       <div class="panel-heading">
        <h3 class="panel-title">
         Recent Posts
        </h3>
       </div>
       <div class="list-group" id="recent_posts">
        <a class="list-group-item " href="/gustavo/blog/post/home-row-computing-on-mac/">
         Home Row Computing on Macs
        </a>
        <a class="list-group-item " href="/gustavo/blog/post/system-calls/">
         System Calls Make the World Go Round
        </a>
        <a class="list-group-item " href="/gustavo/blog/post/what-does-an-idle-cpu-do/">
         What Does an Idle CPU Do?
        </a>
        <a class="list-group-item " href="/gustavo/blog/post/when-does-your-os-run/">
         When Does Your OS Run?
        </a>
        <a class="list-group-item " href="/gustavo/blog/post/closures-objects-heap/">
         Closures, Objects, and the Fauna of the Heap
        </a>
       </div>
      </section>
      <div>
       <a href="/gustavo/blog/about/" title="about">
        <img alt="Author and his dog Chai" src="/gustavo/blog/images/circleChai120px.png" style="display: block;margin:40px auto"/>
       </a>
      </div>
      <div class="socialNav">
       <ul class="socialNav">
        <li style="float:left">
         <a href="//twitter.com/food4hackers" title="follow me">
          <img src="/gustavo/blog/images/twitter.png"/>
         </a>
        </li>
        <li style="float:right">
         <a href="mailto:food4hackers@duartes.org" title="email me">
          <img src="/gustavo/blog/images/email.png"/>
         </a>
        </li>
        <li>
         <a href="http://feeds.feedburner.com/GustavoDuarte" rel="subscribe-rss" title="subscribe via RSS">
          <img src="/gustavo/blog/images/rss.png"/>
         </a>
        </li>
       </ul>
      </div>
     </aside>
    </div>
   </div>
  </div>
  <div id="footer" role="contentinfo">
   <div class="container">
    <p>
     Copyright  2008-2014 Gustavo Duarte -
     <span class="credit">
      Powered by
      <a href="http://octopress.org">
       Octopress
      </a>
     </span>
    </p>
   </div>
  </div>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]&gt;
    &lt;script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"&gt;&lt;/script&gt;
    &lt;script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"&gt;&lt;/script&gt;
&lt;![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js">
  </script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js">
  </script>
 </body>
</html>