<!DOCTYPE html>
<html>
 <head>
  <title>
   Using Node.js to join audio files
  </title>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" user-scalable="no"/>
  <meta content="A node.js program for manipulating audio files" name="description"/>
  <meta content="Node Blogger" name="generator"/>
  <script type="text/javascript">
   //&lt;![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"dd686e193d83a8438e3c2b23cdd0cb4e",petok:"ec4f3e27df40c1fbd93c4fa85b4b3001175580a5-1436855387-86400",betok:"5e753e5f11200f81e42f83af949de6ae9581254f-1436855387-120",zone:"ragingflame.co.za",rocket:"0",apps:{}}];CloudFlare.push({"apps":{"smarterror":{"swiftype":{"engine_key":""}}}});!function(a,b){a=document.createElement("script"),b=document.getElementsByTagName("script")[0],a.async=!0,a.src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=7e13c32551/cloudflare.min.js",b.parentNode.insertBefore(a,b)}()}}catch(e){};
//]]&gt;
  </script>
  <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="/css/style.css" rel="stylesheet"/>
  <link href="http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700&amp;subset=latin,cyrillic-ext" rel="stylesheet"/>
  <!--[if lt IE 9]&gt;
&lt;script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
&lt;![endif]-->
 </head>
 <body>
  <aside>
   <h1>
    <a href="/">
     <img alt="Qawelesizwe Mlilo" class="img-circle desktop" src="/img/q-mobile.png" title="Qawelesizwe Mlilo"/>
    </a>
   </h1>
   <p class="description">
    Hi, my name is Qawelesizwe Mlilo(or Que), a Software Developer currently based in Cape Town, S.A. This blog is about my programming (adventures || misadventures).
    <br/>
    <br/>
    <a href="https://github.com/qawemlilo/blog" target="_blank">
     Send me a pull request
    </a>
    for corrections and edits.
   </p>
   <ul>
    <li>
     <a href="/">
      Home
     </a>
    </li>
    <li>
     <a href="/about">
      About
     </a>
    </li>
    <li>
     <a href="https://github.com/qawemlilo" target="_blank">
      Projects
     </a>
    </li>
    <li>
     <a href="/cdn-cgi/l/email-protection#3f4e5e485a52535653507f58525e5653115c5052">
      Contact Me
     </a>
    </li>
   </ul>
   <p class="author">
    <a class="github" href="https://github.com/qawemlilo" target="_blank" title="Github">
    </a>
    <a class="twitter" href="http://twitter.com/ragingflameblog" target="_blank" title="Twitter">
    </a>
    <a class="google" href="https://plus.google.com/111595084798587457827/posts?hl=en&amp;partnerid=gplp0" target="_blank" title="Google">
    </a>
    <a class="rss" href="/rss" title="RSS">
    </a>
   </p>
  </aside>
  <section id="content">
   <div class="post blogpost">
    <h1>
     Using Node.js to join audio files
    </h1>
    <div class="date">
     <div class="dt">
      31 May 2013
     </div>
     <div class="sharep">
      Share
      <a class="share-fb" href="http://www.facebook.com/share.php?u=http://blog.ragingflame.co.za/2013/5/31/using-nodejs-to-join-audio-files" target="_blank" title="Share on Facebook">
      </a>
      <a class="share-twitter" href="http://twitter.com/home?status=http://blog.ragingflame.co.za/2013/5/31/using-nodejs-to-join-audio-files" target="_blank" title="Share on Twitter">
      </a>
      <a class="share-reddit" href="http://reddit.com/submit?url=http://blog.ragingflame.co.za/2013/5/31/using-nodejs-to-join-audio-files" target="_blank" title="Share on Reddit">
      </a>
      <a class="share-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://blog.ragingflame.co.za/2013/5/31/using-nodejs-to-join-audio-files" target="_blank" title="Share on LinkedIn">
      </a>
     </div>
    </div>
    <p style="clear:both">
    </p>
    <p>
     Today I decided to clean up and organise files on my windows machine at work. This process involved deleting files I no longer have use for and grouping the rest in folders.  So I ended up with folders for audio, video, projects, ebooks, e.t.c.
    </p>
    <p>
     One of the folders that I opened contained about 50 small mp3 files. Before deleting the files I had to play them just to make sure they didn't contain anything important. What do I know, turns out they are clips of a DHH(the RoR creator) interview - please don't ask me how they got to my computer.  He's quite an opinionated guy so I decided to keep the files. But 50 files? Wouldn't it be nice if I could glue them together into a single file? Well, being the hacker that I am I popped open my terminal and started writing a program.
    </p>
    <p>
     I broke down the task to two main parts.
    </p>
    <ol>
     <li>
      Read and sort the files according to their sequence
     </li>
     <li>
      Some how combine the files and write them to a single file
     </li>
    </ol>
    <p>
     The first part turned out to be quite easy because the files were named with a date/time stamp in the following format:
     <code>
      Mon Jan 03 10;02;07 2011.mp3
     </code>
     . This meant that I could extract the time from the file names and sort them accordingly. To simplify this further I decided to rename the files with an easier format for sorting - for this I created the
     <code>
      rename.js
     </code>
     file:
    </p>
    <pre>
     <code>
      /*
   I placed all the audio files in ./files directory
*/
var fs = require('fs'),
    files = fs.readdirSync('./files');

files.forEach(function (file) {
    var currentname = './files/' + file, 
        date = parseDate(file),
        newname = './files/' + date.split(';').join('') + '.mp3';

    renameFile(currentname, newname); 
    console.log('Renamed ' + currentname + ' to ' + newname);    
}); 

/*
    This function renames a file

    @param: (String) currentname - current file name
    @param: (String) newname - new file name     
*/
function renameFile(currentname, newname) {
    fs.renameSync(currentname, newname);
}

/*
    Extracts date/time from file name string

    @param: (String) filename - file name 
*/
function parseDate(name) {
    var date = name.substring(11, 19);

    return date;
}

console.log('Done');
     </code>
    </pre>
    <p>
     Up next I had to create the main program that combines the files and writes them to a single file. Streams to the rescue!
    </p>
    <h3>
     What are streams?
    </h3>
    <p>
     Streams are a powerful feature in Node.js, they create a transportation system that moves your data in chunks. The source of the data is a readable stream and the destination a writable stream. The file system module has 2 methods that you can use to take advantage of Node streams,
     <code>
      fs.createReadStream
     </code>
     and
     <code>
      fs.createWriteStream
     </code>
     . I created a new file for the main program,
     <code>
      stream.js
     </code>
    </p>
    <pre>
     <code>
      var fs = require('fs'),
    files = fs.readdirSync('./files'),
    clips = [],
    stream,
    currentfile,
    dhh = fs.createWriteStream('./dhh-interview.mp3');

// create an array with filenames (time)
files.forEach(function (file) {
    clips.push(file.substring(0, 6));  
});

// Sort
clips.sort(function (a, b) {
    return a - b;
});

// recursive function
function main() {
    if (!clips.length) {
        dhh.end("Done");
        return;
    }

    currentfile = './files/' + clips.shift() + '.mp3';
    stream = fs.createReadStream(currentfile);

    stream.pipe(dhh, {end: false});

    stream.on("end", function() {
        console.log(currentfile + ' appended');
        main();        
    });
}


main();
     </code>
    </pre>
    <p>
     That's it. Lastly I needed to run my programs.
    </p>
    <pre>
     <code>
      node rename.js &amp;&amp; node stream.js
     </code>
    </pre>
    <p>
     <strong>
      Note:
     </strong>
     I have included a few files in
     <a href="https://github.com/qawemlilo/node-streams">
      my repo
     </a>
     so that you can be able to try this out.
    </p>
   </div>
   <a class="pagination-arrow newer" href="/2013/5/9/about-this-blog" title="Previous Post">
    Prev
   </a>
   <a class="pagination-arrow older" href="/2013/6/8/the-state-of-node" title="Next Post">
    Next
   </a>
   <div id="disqus_thread">
   </div>
   <a class="dsq-brlink" href="http://disqus.com">
    comments powered by
    <span class="logo-disqus">
     Disqus
    </span>
   </a>
  </section>
  <script src="/js/script-min.js" type="text/javascript">
  </script>
  <script type="text/javascript">
   var disqus_shortname = 'ragingflameblog';
    var disqus_identifier = '/2013/5/31/using-nodejs-to-join-audio-files';
    var disqus_title = 'Using Node.js to join audio files';
    var disqus_url = 'http://blog.ragingflame.co.za/2013/5/31/using-nodejs-to-join-audio-files';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>
   Please enable JavaScript to view the
   <a href="http://disqus.com/?ref_noscript">
    comments powered by Disqus.
   </a>
  </noscript>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41105756-1', 'ragingflame.co.za');
  ga('send', 'pageview');
  </script>
  <script type="text/javascript">
   /* &lt;![CDATA[ */
(function(){try{var s,a,i,j,r,c,l=document.getElementsByTagName("a"),t=document.createElement("textarea");for(i=0;l.length-i;i++){try{a=l[i].getAttribute("href");if(a&amp;&amp;a.indexOf("/cdn-cgi/l/email-protection") &gt; -1  &amp;&amp; (a.length &gt; 28)){s='';j=27+ 1 + a.indexOf("/cdn-cgi/l/email-protection");if (a.length &gt; j) {r=parseInt(a.substr(j,2),16);for(j+=2;a.length&gt;j&amp;&amp;a.substr(j,1)!='X';j+=2){c=parseInt(a.substr(j,2),16)^r;s+=String.fromCharCode(c);}j+=1;s+=a.substr(j,a.length-j);}t.innerHTML=s.replace(/&lt;/g,"&lt;").replace(/&gt;/g,"&gt;");l[i].setAttribute("href","mailto:"+t.value);}}catch(e){}}}catch(e){}})();
/* ]]&gt; */
  </script>
 </body>
</html>