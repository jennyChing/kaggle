<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
  <title>
   LKML: Linus Torvalds: Re: Random panic in load_balance() with 3.16-rc
  </title>
  <link href="/css/message.css" rel="stylesheet" type="text/css"/>
  <link href="/css/wrap.css" rel="alternate stylesheet" title="wrap" type="text/css"/>
  <link href="/css/nowrap.css" rel="stylesheet" title="nowrap" type="text/css"/>
  <link href="/favicon.ico" rel="shortcut icon"/>
  <script src="/js/simple-calendar.js" type="text/javascript">
  </script>
  <script src="/js/styleswitcher.js" type="text/javascript">
  </script>
  <link href="/rss.php" rel="alternate" title="lkml.org : last 100 messages" type="application/rss+xml"/>
  <link href="/groupie.php?aid=1" rel="alternate" title="lkml.org : last messages by Linus Torvalds" type="application/rss+xml"/>
 </head>
 <body itemscope="itemscope" itemtype="http://schema.org/BlogPosting" onload="es.jasper.simpleCalendar.init();">
  <table border="0" cellpadding="0" cellspacing="0">
   <tr>
    <td align="center" width="180">
     <a href="/">
      <img alt="lkml.org" src="/images/toprowlk.gif" style="border:0;width:135px;height:32px"/>
     </a>
    </td>
    <td width="32">
    </td>
    <td class="nb">
     <div>
      <a class="nb" href="/lkml">
       [lkml]
      </a>
      <a class="nb" href="/lkml/2014">
       [2014]
      </a>
      <a class="nb" href="/lkml/2014/7">
       [Jul]
      </a>
      <a class="nb" href="/lkml/2014/7/24">
       [24]
      </a>
      <a class="nb" href="/lkml/last100">
       [last100]
      </a>
      <a href="/rss.php">
       <img alt="RSS Feed" border="0" src="/images/rss-or.gif"/>
      </a>
     </div>
     <div>
      Views:
      <a class="nowrap" href="#" onclick="setActiveStyleSheet('wrap');return false;">
       [wrap]
      </a>
      <a class="wrap" href="#" onclick="setActiveStyleSheet('nowrap');return false;">
       [no wrap]
      </a>
      <a class="nb" href="/lkml/mheaders/2014/7/24/584" onclick="this.href='/lkml/headers'+'/2014/7/24/584';">
       [headers]
      </a>
      <a href="/lkml/bounce/2014/7/24/584">
       [forward]
      </a>
     </div>
    </td>
    <td width="32">
    </td>
   </tr>
   <tr>
    <td valign="top">
     <div baseurl="/lkml/" class="es-jasper-simpleCalendar">
     </div>
     <div class="threadlist">
      Messages in this thread
     </div>
     <ul class="threadlist">
      <li class="root">
       <a href="/lkml/2014/7/17/100">
        First message in thread
       </a>
      </li>
      <li>
       <a href="/lkml/2014/7/23/871">
        Peter Zijlstra
       </a>
       <ul>
        <li>
         <a href="/lkml/2014/7/23/572">
          Linus Torvalds
         </a>
        </li>
        <li>
         <a href="/lkml/2014/7/23/802">
          =?UTF-8?B?TWljaGVsIETDpG56ZXI=?=
         </a>
         <ul>
          <li class="origin">
           <a href="/lkml/2014/7/24/560">
            Linus Torvalds
           </a>
           <ul>
            <li>
             <a href="/lkml/2014/7/24/560">
              Peter Zijlstra
             </a>
            </li>
            <li>
             <a href="/lkml/2014/7/24/755">
              =?UTF-8?B?TWljaGVsIETDpG56ZXI=?=
             </a>
             <ul>
              <li>
               <a href="/lkml/2014/7/24/781">
                Linus Torvalds
               </a>
              </li>
              <li>
               <a href="/lkml/2014/7/24/791">
                Nick Krause
               </a>
              </li>
              <li>
               <a href="/lkml/2014/7/24/824">
                Alexei Starovoitov
               </a>
              </li>
              <li>
               <a href="/lkml/2014/7/26/142">
                Steven Chamberlain
               </a>
              </li>
             </ul>
            </li>
            <li>
             <a href="/lkml/2014/7/25/97">
              Jakub Jelinek
             </a>
             <ul>
              <li>
               <a href="/lkml/2014/7/25/100">
                Linus Torvalds
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </td>
    <td class="c" rowspan="2" valign="top" width="32">
     <img alt="/" height="32" src="/images/icornerl.gif" width="32"/>
    </td>
    <td class="c" rowspan="2" style="padding-top: 1em" valign="top">
     <table>
      <tr>
       <td colspan="2">
        <!--BuySellAds Zone Code-->
        <script type="text/javascript">
         ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"lkml","width":728,"height":90,"sid":"Chitika Default","color_site_link":"000080","color_bg":"DDE8E8"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('&lt;div id="chitikaAdBlock-' + placement_id + '"&gt;&lt;/div&gt;');
}());
        </script>
        <script async="async" src="//cdn.chitika.net/getads.js" type="text/javascript">
        </script>
       </td>
      </tr>
      <tr>
       <td>
        <table>
         <tr>
          <td class="lp">
           Date
          </td>
          <td class="rp" itemprop="datePublished">
           Thu, 24 Jul 2014 11:47:17 -0700
          </td>
         </tr>
         <tr>
          <td class="lp">
           Subject
          </td>
          <td class="rp" itemprop="name">
           Re: Random panic in load_balance() with 3.16-rc
          </td>
         </tr>
         <tr>
          <td class="lp">
           From
          </td>
          <td class="rp" itemprop="author">
           Linus Torvalds &lt;&gt;
          </td>
         </tr>
        </table>
       </td>
       <td>
        <div class="g-plusone" data-count="true" data-size="standard">
        </div>
       </td>
      </tr>
     </table>
     <pre itemprop="articleBody">
      On Wed, Jul 23, 2014 at 6:43 PM, Michel Dnzer &lt;michel@daenzer.net&gt; wrote:
      <br/>
      &gt;&gt;
      <br/>
      &gt;&gt; Michel, mind doing
      <br/>
      &gt;&gt;
      <br/>
      &gt;&gt;     make kernel/sched/fair.s
      <br/>
      &gt;&gt;
      <br/>
      &gt;&gt; and sending us the resulting file?
      <br/>
      &gt;
      <br/>
      &gt; Here it is, gzipped, hope that's okay.
      <br/>
      &gt;
      <br/>
      &gt; Note that my tree is now based on 3.16-rc6.
      <br/>
      <br/>
      Ok, so I'm looking at the code generation and your compiler is pure
      <br/>
      and utter *shit*.
      <br/>
      <br/>
      Adding Jakub to the cc, because gcc-4.9.0 seems to be terminally broken.
      <br/>
      <br/>
      Lookie here, your compiler does some absolutely insane things with the
      <br/>
      spilling, including spilling a *constant*. For chrissake, that
      <br/>
      compiler shouldn't have been allowed to graduate from kindergarten.
      <br/>
      We're talking "sloth that was dropped on the head as a baby" level
      <br/>
      retardation levels here:
      <br/>
      <br/>
      ...
      <br/>
      movq    $load_balance_mask, -136(%rbp)  #, %sfp
      <br/>
      subq    $184, %rsp      #,
      <br/>
      movq    (%rdx), %rax    # sd_22(D)-&gt;parent, sd_parent
      <br/>
      movl    %edi, -144(%rbp)        # this_cpu, %sfp
      <br/>
      movl    %ecx, -140(%rbp)        # idle, %sfp
      <br/>
      movq    %r8, -200(%rbp) # continue_balancing, %sfp
      <br/>
      movq    %rax, -184(%rbp)        # sd_parent, %sfp
      <br/>
      movq    -136(%rbp), %rax        # %sfp, tcp_ptr__
      <br/>
      #APP
      <br/>
      add %gs:this_cpu_off, %rax      # this_cpu_off, tcp_ptr__
      <br/>
      #NO_APP
      <br/>
      ...
      <br/>
      <br/>
      Note the contents of -136(%rbp). Seriously. That's an
      <br/>
      _immediate_constant_ that the compiler is spilling.
      <br/>
      <br/>
      Somebody needs to raise that as a gcc bug. Because it damn well is
      <br/>
      some seriously crazy shit.
      <br/>
      <br/>
      However, that constant spilling part just counts as "too stupid to
      <br/>
      live". The real bug is this:
      <br/>
      <br/>
      movq    $load_balance_mask, -136(%rbp)  #, %sfp
      <br/>
      subq    $184, %rsp      #,
      <br/>
      <br/>
      where gcc creates the stack frame *after* having already used it to
      <br/>
      save that constant *deep* below the stack frame.
      <br/>
      <br/>
      The x86-64 ABI specifies a 128-byte red-zone under the stack pointer,
      <br/>
      and this is ok by that limit. It looks like it's illegal (136 &gt; 128),
      <br/>
      but the fact is, we've had four "pushq"s to update %rsp since loading
      <br/>
      the frame pointer, so it's just *barely* legal with the red-zoning.
      <br/>
      But we build the kernel with -mno-red-zone. We do *not* follow the
      <br/>
      x86-64 ABI wrt redzoning, because we *cannot*: interrupts while in
      <br/>
      kernel mode *will* use the stack without a redzone. So that
      <br/>
      "-mno-red-zone" is not some "optional guideline". It's a hard and
      <br/>
      harsh requirement for the kernel, and gcc-4.9 is a buggy piece of shit
      <br/>
      for ignoring it. And your bug happens becuase you happen to hit an
      <br/>
      interrupt _just_ in that single instruction window (or perhaps hit
      <br/>
      some other similar case and corrupted kernel data structures earlier).
      <br/>
      <br/>
      Now, I suspect that this redzoning bug might actually be related to
      <br/>
      the fact that gcc is stupid in spilling a constant. I would not be
      <br/>
      surprised if there is some liveness analysis going on to decide *when*
      <br/>
      to insert the stack decrement, and constants are being ignored because
      <br/>
      clearly liveness isn't an issue for a constant value. So the two bugs
      <br/>
      ("stupid constant spilling" and "invalid use or red zone stack") go
      <br/>
      hand in hand. But who knows.
      <br/>
      <br/>
      Anyway, this is not a kernel bug. This is your compiler creating
      <br/>
      completely broken code. We may need to add a warning to make sure
      <br/>
      nobody compiles with gcc-4.9.0, and the Debian people should probably
      <br/>
      downgrate their shiny new compiler.
      <br/>
      <br/>
      Jakub, any ideas?
      <br/>
      <br/>
      Linus
      <br/>
      --
      <br/>
      To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
      <br/>
      the body of a message to majordomo@vger.kernel.org
      <br/>
      More majordomo info at
      <a href="http://vger.kernel.org/majordomo-info.html">
       http://vger.kernel.org/majordomo-info.html
      </a>
      <br/>
      Please read the FAQ at
      <a href="http://www.tux.org/lkml/">
       http://www.tux.org/lkml/
      </a>
      <br/>
      <br/>
     </pre>
     <div align="center">
      <div class="g-plusone" data-count="true" data-size="standard">
      </div>
     </div>
    </td>
    <td class="c" rowspan="2" valign="top" width="32">
     <img alt="\" height="32" src="/images/icornerr.gif" width="32"/>
    </td>
   </tr>
   <tr>
    <td align="right" valign="bottom">
    </td>
   </tr>
   <tr>
    <td align="right" valign="bottom">
    </td>
    <td class="c" style="padding-bottom: 0px" valign="bottom">
     <img alt="\" height="32" src="/images/bcornerl.gif" width="32"/>
    </td>
    <td class="c">
    </td>
    <td class="c" style="padding-bottom: 0px" valign="bottom">
     <img alt="/" height="32" src="/images/bcornerr.gif" width="32"/>
    </td>
   </tr>
   <tr>
    <td align="right" colspan="2" valign="top">
    </td>
    <td class="lm">
     Last update: 2014-07-24 22:21  [from the cache]
     <br/>
     2003-2014
     <a href="http://jasper.es/">
      <span itemprop="editor">
       Jasper Spaans
      </span>
     </a>
     . hosted at
     <a href="https://www.digitalocean.com/?refcode=9a8e99d24cf9">
      Digital Ocean
     </a>
    </td>
    <td>
    </td>
   </tr>
  </table>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-563378-1', 'auto');
ga('send', 'pageview');
  </script>
  <script type="text/javascript">
   (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
  </script>
  <script language="javascript" src="/js/styleswitcher.js" type="text/javascript">
  </script>
  <script language="javascript" src="https://lkml.org/redirect.js" type="text/javascript">
  </script>
 </body>
</html>